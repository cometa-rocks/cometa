services:
  db:
    container_name: cometa_postgres
    image: postgres:12.1
    volumes:
      - ./backend:/code
      - ./data/db_data:/var/lib/postgresql/data
    expose:
      - "5532"
    networks:
     - testing
    restart: always

  django:
    container_name: cometa_django
    image: python:3.11
    logging:
      driver: json-file
    command: bash start.sh
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/cometa:/data:rw
      - ./data/cometa/screenshots:/data/screenshots
      - ./data/cometa/videos:/data/videos
      - ./data/cometa/pdf:/data/pdf
      - ./data/cometa/downloads:/data/downloads:rw
      - ./data/cometa/uploads:/data/uploads:rw
      - ./data/department_data:/data/department_data:rw
      - ./data/cometa/config:/code/config:rw
      - ./data/django/migrations:/opt/code/migrations:rw
      - ./data/django/logs:/opt/code/logs:rw
      - ./data/django/clamav:/var/lib/clamav:rw
      - ./backend:/code
      - ./backend/src:/opt/code:rw
    working_dir: /opt/code
    environment:
      - PYTHONUNBUFFERED=1
    expose:
      - "8000"
    depends_on:
      - db
    links:
      - behave:cometabehave.local
    networks:
     - testing
    restart: always

  behave:
    container_name: cometa_behave
    image: python:3.11
    logging:
      driver: json-file
    expose:
      - "8001"
    depends_on:
      redis:
        condition: service_healthy
      # FIXME Add healthcheck for django, and remove circular dependency of django on behave
      # django:
      #   condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/cometa:/data:rw
      - ./data/cometa/screenshots:/data/screenshots
      - ./data/cometa/downloads:/data/test/downloads
      - ./data/cometa/uploads:/data/test/uploads
      - ./data/cometa/videos:/data/videos
      - ./data/department_data:/data/department_data:rw
      - ./data/cometa/config:/code/config:rw
      - ./data/redis/certs:/share/certs
      - ./data/django/logs:/opt/code/logs
      - ./backend/behave:/opt/code:rw
      - ./backend:/code
    command: "/opt/code/behave_django/entry.sh"
    working_dir: /opt/code/behave_django
    environment:
      PYTHONUNBUFFERED: 1
    networks:
     - testing
    restart: always

  ws:
    container_name: cometa_socket
    image: cometa/socket:1.2
    environment:
      - NODE_ENV=production
      - NPM_CONFIG_LOGLEVEL=info
    expose:
      - "3001"
    networks:
     - testing
    restart: always

  selenoid:
    # Please use ./selenoid/deploy_selenoid.sh to create necessary files of Selenoid
    image: aerokube/selenoid:1.11.2
    container_name: cometa_selenoid
    logging:
      driver: json-file
    ports:
      - 4444:4444
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./backend/selenoid/:/etc/selenoid/:rw
      - ./data/cometa/config/images:/code/config/images:rw
      - ./data/cometa/videos:/opt/selenoid/video
    environment:
      TZ: Europe/Berlin
      OVERRIDE_VIDEO_OUTPUT_DIR: ${PWD}/data/cometa/videos
    networks:
      - testing
    restart: always
    entrypoint: sh /etc/selenoid/start.sh

  novnc:
    image: cometa/novnc:1.6
    container_name: cometa_novnc
    networks:
      - testing
    restart: always

  crontab:
    image: cometa/scheduler:latest
    container_name: cometa_crontab
    environment:
      CRONTAB_SERVER_URL: "crontab"
      CRONTAB_SERVER_PORT: "8080"
      SCHEDULER_HOST: "crontab"
      SCHEDULER_PORT: "8080"
    networks:
      - testing
    restart: always

  # Since this a deployment file, build image is used to start cometa_front 
  # n the build pipeline 
  apache:
    image: "cometa/front:3.0.14"
    container_name: cometa_front
    volumes:
      - ./data/front/apache2/metadata:/usr/local/apache2/conf/metadata
      - ./data/front/apache2/conf/httpd.conf:/usr/local/apache2/conf/httpd.conf
      - ./data/front/apache2/conf/openidc.conf:/usr/local/apache2/conf/openidc.conf
      - ./data/front/apache2/conf/paths.conf:/usr/local/apache2/conf/paths.conf
      - ./data/front/apache2/modules/mod_auth_openidc.so:/usr/local/apache2/modules/mod_auth_openidc.so
      - ./data/front/apache2/certs:/share/apache2/certs
      - ./data/cometa/screenshots:/screenshots
      - ./data/cometa/videos:/videos
      - ./front/start_server.sh:/code/front/start_server.sh
      # Use below line to mount the company logo in the login page
      # - /share/front/apache2/icons/{{COMPANY}}.svg:/usr/local/apache2/htdocs/assets/icons/{{COMPANY}}.svg

    working_dir: /code/front
    privileged: true
    ports:
      - "<outside_port>:80"
      - "443:443"
    entrypoint: bash /code/front/start_server.sh
    environment:
      - DJANGO_SERVER_URL=django
      - DJANGO_SERVER_PORT=8000
      - SOCKET_SERVER_URL=ws
      - SOCKET_SERVER_PORT=3001
      - SELENOID_SERVER_URL=selenoid
      - SELENOID_SERVER_PORT=4444
      - NOVNC_SERVER_URL=novnc
      - NOVNC_SERVER_PORT=80
    networks:
      - testing
    restart: always

  redis:
    image: redis:7.2.0-alpine
    container_name: cometa_redis
    volumes:
      - redis_data:/data
    networks:
      - testing
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
    restart: always

networks:
  testing:
    driver: "bridge"

volumes:
  redis_data: