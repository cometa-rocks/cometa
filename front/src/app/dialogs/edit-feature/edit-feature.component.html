<form [formGroup]="featureForm">
  <ng-container *ngIf="data.mode === 'new'; else editTitle">
    <h2 mat-dialog-title>{{ "feature.create_new" | translate }}</h2>
  </ng-container>
  <ng-template #editTitle>
    <ng-container *ngIf="data.mode === 'edit'; else cloneTitle">
      <h2 mat-dialog-title>
        {{ "feature.edit_feature" | translate }} {{ featureForm.get('feature_name').value }}
      </h2>
    </ng-container>
    <ng-template #cloneTitle>
      <h2 mat-dialog-title>{{ "feature.clone_feature" | translate }}</h2>
    </ng-template>
  </ng-template>
  <mat-dialog-content>
    <mat-accordion multi>
      <mat-expansion-panel [expanded]="!config$.toggles.hideInformation">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>{{ "feature.information_tittle" | translate }}</span>
          </mat-panel-title>
          <mat-panel-description
            >{{ "feature.panel_description" | translate }}</mat-panel-description
          >
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <div class="edit-feature-info">
            <mat-form-field appearance="fill" class="edit-dep">
              <mat-label>{{ "feature.department" | translate }}</mat-label>
              <mat-select
                [(ngModel)]="selected_department"
                [disabled]="data.mode === 'edit'"
                formControlName="department_name">
                <mat-option
                  *ngFor="let dep of departments$ | sortBy: 'department_name'"
                  [value]="dep.department_name">
                  {{ dep.department_name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="fill" class="edit-app">
              <mat-label>{{ "feature.application" | translate }}</mat-label>
              <mat-select
                [(ngModel)]="selected_application"
                formControlName="app_name">
                <mat-option
                  *ngFor="let app of applications$ | sortBy: 'app_name'"
                  [value]="app.app_name">
                  {{ app.app_name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="fill" class="edit-env">
              <mat-label>{{ "feature.environment" | translate }}</mat-label>
              <mat-select
                [(ngModel)]="selected_environment"
                formControlName="environment_name">
                <mat-option
                  *ngFor="let env of environments$ | sortBy: 'environment_name'"
                  [value]="env.environment_name">
                  {{ env.environment_name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="fill" class="edit-name">
              <mat-label>{{ "feature.name" | translate }}</mat-label>
              <input
                matInput
                spellcheck="false"
                formControlName="feature_name" 
                (focus)="onInputFocus()" 
                (blur)="onInputBlur()"
                />
            </mat-form-field>
            <mat-form-field appearance="fill" class="edit-description">
              <mat-label>
                {{ "feature.textarea_description" | translate }}
              </mat-label>
              <textarea
                spellcheck="false"
                formControlName="description"
                matInput
                rows="1"
                (focus)="onInputFocus()" 
                (blur)="onInputBlur()"
                ></textarea>
            </mat-form-field>
          </div>
          <div
            *ngIf="selected_department === 'Default' && departments$.length > 1"
            class="department-warning">
            <mat-icon>info</mat-icon>
            <span
              >Selecting <strong>Default</strong> department will make this
              feature visible to everyone, use it with caution!</span
            >
          </div>
          <div class="depends">
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()">
              <mat-checkbox color="primary" formControlName="depends_on_others" [matTooltip]="'edit_feature.depends_on_other_feature' | translate" matTooltipPosition="above">
                {{ "feature.depends_other_feature" | translate }}
              </mat-checkbox>
              <div class="hover-box">(D)</div>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()">   
              <mat-checkbox color="primary" formControlName="send_mail" [matTooltip]="'edit_feature.send_mail' | translate" matTooltipPosition="above">
                {{ "feature.sends_email" | translate }}
              </mat-checkbox>
              <div class="hover-box">(M)</div>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()">   
              <mat-checkbox color="primary" *ngIf="!featureForm.value.depends_on_others" formControlName="video" [matTooltip]="'edit_feature.record_video' | translate" matTooltipPosition="above">
                {{ "feature.record_video" | translate }}
              </mat-checkbox>
              <div class="hover-box">(R)</div>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()">   
              <mat-checkbox
                color="primary"
                *ngIf="!featureForm.value.depends_on_others"
                formControlName="network_logging"
                [matTooltip]="'edit_feature.network_logging' | translate" matTooltipPosition="above">
                {{ "feature.network_logging" | translate }}
              </mat-checkbox>
              <div class="hover-box">(N)</div>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()"> 
              <mat-checkbox
                color="primary"
                *ngIf="!featureForm.value.depends_on_others"
                formControlName="generate_dataset"
                [matTooltip]="'edit_feature.generate_dataset' | translate" matTooltipPosition="above">
                {{ "feature.generate_dataset" | translate }}
              </mat-checkbox>
              <div class="hover-box">(G)</div>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()">  
              <ng-container *ngLet="((departmentSettings$ | async)?.continue_on_failure || user.settings?.continue_on_failure) as disabled">
                <mat-checkbox [matTooltip]="'continue_on_failure.tooltip' | translate" [matTooltipDisabled]="!disabled" color="primary" [disabled]="disabled" formControlName="continue_on_failure">
                  {{ "feature.continue_failure" | translate }}
                </mat-checkbox>
                <div class="hover-box">(F)</div>
              </ng-container>
            </div>
            <div class="checkbox-container" (mouseover)="onMouseOver()" (mouseout)="onMouseOut()"> 
              <mat-checkbox color="primary" formControlName="need_help" [matTooltip]="'edit_feature.explanation' | translate" matTooltipPosition="above">
                {{ 'feature.help' | translate }}
              </mat-checkbox>
              <div class="hover-box">(H)</div>
            </div>
            <ng-container *ngLet="(!featureForm.value.environment_name || !featureForm.value.department_name) as disableVariables">
              <div class="checkbox-container move-right"> 
                <span class="edit-variables" [matTooltip]="'tooltips.variables_requires' | translate" [matTooltipDisabled]="!disableVariables">
                  <button color="primary" 
                  [disabled]="disableVariables" 
                  (click)="editVariables()" 
                  mat-stroked-button 
                  [matTooltip]="'edit_feature.edit_variable' | translate" matTooltipPosition="above">
                  {{ "feature.edit_variables" | translate }}
                  </button>
                </span>
                <div class="hover-box-Vshortcut">(V)</div>
              </div>
            </ng-container>
          </div>
        </ng-template>
      </mat-expansion-panel>
      <mat-expansion-panel
        *ngIf="
          featureForm.value.send_mail && !featureForm.value.depends_on_others
        "
        [expanded]="!config$.toggles.hideSendMail">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>
              {{ "feature.email_tittle" | translate }}
            </span>
          </mat-panel-title>
          <mat-panel-description>
            {{ "feature.email_panel_description" | translate }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>
              {{ "feature.email_address_placeholder" | translate }}
            </mat-label>
            <mat-chip-list #chipList>
              <mat-chip
                *ngFor="let addr of featureForm.get('email_address').value"
                [removable]="true"
                (removed)="removeAddress(addr)"
                >{{ addr }}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip>
              <input
                formControlName="address_to_add"
                [matChipInputFor]="chipList"
                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                [matChipInputAddOnBlur]="true"
                (matChipInputTokenEnd)="addAddress($event)"
                (focus)="onInputFocus()" 
                (blur)="onInputBlur()" />
            </mat-chip-list>
          </mat-form-field>
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>
              {{ "feature.email_subject_placeholder" | translate }}
            </mat-label>
            <input
              matInput
              spellcheck="false"
              formControlName="email_subject"
              (focus)="onInputFocus()" 
              (blur)="onInputBlur()"
              />
          </mat-form-field>
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>
              {{ "feature.email_body_placeholder" | translate }}
            </mat-label>
            <textarea
              matInput
              spellcheck="false"
              formControlName="email_body"
              (focus)="onInputFocus()" 
              (blur)="onInputBlur()"
              ></textarea>
          </mat-form-field>
          <mat-radio-group formControlName="send_mail_on_error">
            {{ "feature.email_group_radios" | translate }}
            <mat-radio-button color="primary" [value]="false">
              {{ "feature.email_radio_always" | translate }}
            </mat-radio-button>
            <mat-radio-button color="primary" [value]="true">
              {{ "feature.email_radio_error" | translate }}
            </mat-radio-button>
          </mat-radio-group>
          <mat-checkbox
            formControlName="do_not_use_default_template"
            aria-label="Screenshot"
            color="primary"
            [matTooltip]="'edit_feature.default_template' | translate" matTooltipPosition="above"
            class="screenshot checkbox-blue default_template"> 
            {{ "feature.email_checkbox_no_default" | translate }}
          </mat-checkbox>
          
          <mat-checkbox
            formControlName="attach_pdf_report_to_email"
            aria-label="Screenshot"
            color="primary"
            [matTooltip]="'edit_feature.attach_pdf' | translate" matTooltipPosition="above"
            class="screenshot checkbox-blue report_to_email"> 
            {{ "feature.email_checkbox_pdf" | translate }}
          </mat-checkbox>

          <button
            (click)="openEmailHelp()"
            stopPropagation
            [matTooltip]="'menu.help' | translate"
            matTooltipPosition="left"
            class="edit-feature-help-icon"
            color="primary"
            mat-icon-button>
            <mat-icon>help_outline</mat-icon>
          </button>
        </ng-template>
      </mat-expansion-panel>

      <!-- FILE UPLOAD -->
      <mat-expansion-panel
        #uploadPanel
        [expanded]="!config$.toggles?.hideUploadedFiles">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>
              {{ "feature.file_tittle" | translate }}
            </span>
            <span class="upload-file">
              <button color="primary" (click)="file.click()" mat-stroked-button>
                {{ "feature.file_upload" | translate }}
              </button>
            </span>
            <input
              type="file"
              multiple="true"
              (change)="onUploadFile($event)"
              #file
              style="display: none" />
          </mat-panel-title>
          <mat-panel-description>
            {{ "feature.file_panel_description" | translate }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <ng-container *ngIf="department?.files.length > 0; else noFiles">
            <div class="table-container">
              <table
                mat-table
                [dataSource]="department?.files"
                class="mat-elevation-z8">
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_name" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">
                    <div class="name-wrapper">
                      <mat-spinner
                        *ngIf="element.status != 'Done'"
                        [matTooltip]="element.status"
                        matTooltipPosition="above"
                        color="primary"
                        diameter="15"></mat-spinner>
                      <span
                        [class.canDownload]="element.status == 'Done'"
                        (click)="onDownloadFile(element)"
                        >{{ element.name }}</span
                      >
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="mime">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_type" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">{{ element.mime }}</td>
                </ng-container>

                <ng-container matColumnDef="size">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_size" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.size | humanizeBytes }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="uploaded_by.name">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_uploaded" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.uploaded_by.name }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="created_on">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_uploaded_date" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">
                    {{
                      element.created_on
                        | amParse
                        | amDateFormat: 'MMMM d yyyy, HH:mm a'
                    }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>
                    {{ "feature.file_actions" | translate }}
                  </th>
                  <td mat-cell *matCellDef="let element">
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="menu"
                      aria-label="file upload">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button
                        mat-menu-item
                        [cdkCopyToClipboard]="element.uploadPath"
                        (cdkCopyToClipboardCopied)="onFilePathCopy($event)"
                        [disabled]="
                          element.status != 'Done' || element.is_removed
                        ">
                        <mat-icon>content_copy</mat-icon>
                        <span>
                          {{ "feature.file_copy_upload_path" | translate }}
                        </span>
                      </button>
                      <button
                        mat-menu-item
                        (click)="onDownloadFile(element)"
                        [disabled]="
                          element.status != 'Done' || element.is_removed
                        ">
                        <mat-icon>cloud_download</mat-icon>
                        <span>
                          {{ "feature.file_copy_upload_path" | translate }}
                        </span>
                      </button>
                      <button
                        mat-menu-item
                        (click)="
                          !element.is_removed
                            ? onDeleteFile(element)
                            : onRestoreFile(element)
                        "
                        [disabled]="element.status != 'Done'">
                        <mat-icon>
                          {{ !element.is_removed ? 'delete' : 'restore' }}
                        </mat-icon>
                        <span >
                          {{ !element.is_removed ? ('feature.file_delete' | translate ) : ('feature.file_restore' | translate) }}
                        </span>
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                  [class.removed]="row.is_removed"></tr>
              </table>
            </div>
          </ng-container>
          <ng-template #noFiles>
            <div class="no-files">
              <p>
                {{ "feature.file_no_files" | translate }}
              </p>
            </div>
          </ng-template>
        </ng-template>
      </mat-expansion-panel>
      <!-- FILE UPLOAD -->

      <mat-expansion-panel
        [expanded]="!config$.toggles.hideBrowsers"
        *ngIf="!featureForm.value.depends_on_others">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>
              {{ "feature.browser_tittle" | translate }}
            </span>
            <ng-container *ngIf="hasSubscription">
              ({{ (browserstackBrowsers | async).length }} {{ "feature.browser_select" | translate }})
            </ng-container>
          </mat-panel-title>
          <mat-panel-description>
            {{ "feature.browser_panel_description" | translate }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <ng-container *ngIf="hasSubscription; else noCloudsAvailable">
            <cometa-browser-selection
              *ngIf="feature | async as feat"
              [feature]="feat"
              (selectionChange)="
                handleBrowserChange($event)
              "></cometa-browser-selection>
          </ng-container>
          <ng-template #noCloudsAvailable>
            <div class="no-clouds">
              {{ "feature.browser_no_clouds" | translate }}
              <a (click)="dialogRef.close()" routerLink="/pricing">
                {{ "feature.browser_prices" | translate }}
              </a>
            </div>
          </ng-template>
        </ng-template>
      </mat-expansion-panel>
      <mat-expansion-panel [expanded]="!config$.toggles.hideSteps">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>
              {{ "feature.step_tittle" | translate }}
            </span>
            ({{ (steps$ | async).length }} {{ "feature.step_defined" | translate }})
          </mat-panel-title>
          <mat-panel-description>
            {{ "feature.step_panel_description" | translate }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <!-- <cometa-step-editor
            *ngIf="feature | async as feat"
            [mode]="data.mode"
            [department]="department"
            [feature]="feat"
            [variables]="variables"
            [name]="featureForm.get('feature_name').value">
          </cometa-step-editor> -->
          <cometa-step-editor 
            (textareaFocusToParent)="receiveDataFromChild($event)" 
            *ngIf="feature | async as feat" 
            [mode]="data.mode" 
            [department]="department" 
            [feature]="feat" 
            [variables]="variables" 
            [name]="featureForm.get('feature_name').value">
          </cometa-step-editor>
        </ng-template>
      </mat-expansion-panel>
      <mat-expansion-panel [expanded]="!config$.toggles.hideSchedule">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>
              {{ "feature.schedule_tiitle" | translate }}
            </span>
          </mat-panel-title>
          <mat-panel-description>
            {{ "feature.schedule_panel_description" | translate }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <h5 (click)="openScheduleHelp()" class="schedule-help">
            {{ "feature.schedule_help" | translate }}
          </h5>
          <div class="run-now">
            <!-- The run_now values have been inverted as now the schedule checkbox behaviour will be the opposite from the previous version -->
            <mat-checkbox formControlName="run_now" color="primary">
              {{ "feature.schedule_checkbox_enable" | translate }}
            </mat-checkbox>
          </div>
          <table *ngIf="featureForm.value.run_now" class="schedule">
            <tr>
              <td>
                <mat-form-field class="form-field-blue">
                  <mat-label>
                    {{ "feature.schedule_minute" | translate }}
                  </mat-label>
                  <input
                    matInput
                    [disabled]="!featureForm.value.schedule"
                    formControlName="minute"
                    disableAutocomplete />
                  <mat-error
                    *ngIf="featureForm.get('minute').hasError('pattern')">
                    {{ "feature.schedule_invalid_format" | translate }}
                    </mat-error>
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="form-field-blue">
                  <mat-label>
                    {{ "feature.schedule_hour" | translate }}
                  </mat-label>
                  <input
                    matInput
                    type="text"
                    [disabled]="!featureForm.value.schedule"
                    formControlName="hour"
                    disableAutocomplete />
                  <mat-error *ngIf="featureForm.get('hour').hasError('pattern')">
                    {{ "feature.schedule_invalid_format" | translate }}
                  </mat-error>
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="form-field-blue">
                  <mat-label>
                    {{ "feature.schedule_day_month" | translate }}
                  </mat-label>
                  <input
                    matInput
                    type="text"
                    [disabled]="!featureForm.value.schedule"
                    formControlName="day_month"
                    disableAutocomplete />
                  <mat-error
                    *ngIf="featureForm.get('day_month').hasError('pattern')">
                    {{ "feature.schedule_invalid_format" | translate }}
                  </mat-error>
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="form-field-blue">
                  <mat-label>
                    {{ "feature.schedule_month" | translate }}
                  </mat-label>
                  <input
                    matInput
                    type="text"
                    [disabled]="!featureForm.value.schedule"
                    formControlName="month"
                    disableAutocomplete />
                  <mat-error
                    *ngIf="featureForm.get('month').hasError('pattern')">
                    {{ "feature.schedule_invalid_format" | translate }}
                  </mat-error>
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="form-field-blue">
                  <mat-label>
                    {{ "feature.schedule_day_week" | translate }}
                  </mat-label>
                  <input
                    matInput
                    type="text"
                    [disabled]="!featureForm.value.schedule"
                    formControlName="day_week"
                    disableAutocomplete />
                  <mat-error
                    *ngIf="featureForm.get('day_week').hasError('pattern')"
                    >
                    {{ "feature.schedule_invalid_format" | translate }}
                  </mat-error>
                </mat-form-field>
              </td>
            </tr>
          </table>
          <div class="next_run" *ngIf="featureForm.value.run_now">
            <ng-container *ngIf="!parseError.error">
              <p [innerHTML]="'feature.schedule_timezone' | translate">
              </p>
              <p [innerHTML]="'feature.schedule_timezone_nextline' | translate: { timezone: timezone }">
              </p>
              <li *ngFor="let nextRun of nextRuns">
                <strong>
                  {{ "feature.schedule_nextrun" | translate }}
                </strong> {{ nextRun }}
              </li>
            </ng-container>
            <ng-container *ngIf="parseError.error">
              <p [innerHTML]="'feature.schedule_error' | translate">
              </p>
            </ng-container>
          </div>
        </ng-template>
      </mat-expansion-panel>
    </mat-accordion>
    <div
      class="last-edition"
      [matTooltip]="edition.email"
      matTooltipPosition="after"
      *ngIf="(feature | async)?.last_edited as edition">
      <b>
        {{ "feature.schedule_last_edit" | translate }}
      </b> {{ edition.name }}
    </div>
  </mat-dialog-content>
  <mat-dialog-actions>
    <div class="right">
      <ng-container *ngLet="saving$ | async as saving">
        <button
          color="warn"
          [disabled]="saving"
          mat-stroked-button
          mat-dialog-close>
          {{ "feature.schedule_cancel" | translate }}
        </button>
        <span
          style="margin-left: 8px"
          matTooltipPosition="above"
          [matTooltip]="'tooltips.invalid_edit_form' | translate"
          [matTooltipDisabled]="featureForm.valid">
          <button
            color="primary"
            [disabled]="saving || featureForm.invalid"
            mat-stroked-button
            class="submit"
            (click)="editOrCreate()">
            <ng-container *ngIf="data.mode === 'new'; else editText">
              {{ "feature.schedule_create" | translate }}
            </ng-container>
            <ng-template #editText>
              {{ "feature.schedule_save" | translate }}
            </ng-template>
          </button>
        </span>
      </ng-container>
    </div>
  </mat-dialog-actions>
</form>
