<div class="info-row" *ngLet="status$ | async as status" [ngClass]="{'inside-loop': isInsideLoop || wasInsideLoop}" [attr.data-loop-step]="isLoopStep">
  <!-- Loop indicator - show for steps within a loop or that were in a loop, but NOT for loop definition and End Loop -->
  <div class="loop-step-indicator" *ngIf="(isInsideLoop || wasInsideLoop) && !isLoopControlStep">
    <mat-icon class="loop-indicator-icon">repeat</mat-icon>
    <span class="loop-indicator-text">Loop</span>
  </div>
  <div class="index">{{ index + 1 }}</div>
  <div
    class="icon-status"
    [ngClass]="status"
    [matTooltip]="status | titlecase"
    matTooltipPosition="above"></div>
  <div class="text" [matTooltip]="step.step_content" matTooltipPosition="above">
    <div class="step-content" [ngClass]="{'loop-step': isLoopStep}">
      {{ step.step_keyword }} {{ step.step_content | truncateApiBody }}
    </div>
    
    
    <!-- Loop Progress Information -->
    <div 
      class="loop-progress-info"
      *ngIf="(isLoopStep || isInsideLoop) && totalLoopIterations"
      [@detailAnimation]>
      <div class="loop-info-content">
        <mat-icon class="loop-icon">repeat</mat-icon>
        <span class="loop-info-text">
          <strong>Loop {{ currentLoopIteration }} of {{ totalLoopIterations }}</strong>
          <span *ngIf="!isLoopStep" class="current-step-indicator">
            â†’ Executing: {{ step.step_keyword }} {{ step.step_content | truncateApiBody }}
          </span>
        </span>
      </div>
    </div>
    
    <!-- Regular step detail -->
    <div
      class="step-detail"
      [@detailAnimation]
      *ngIf="status === 'running' && !isLoopStep && (details$ | async) as detail">
      <div class="icon-detail"></div>
      {{ detail }}
    </div>
  </div>
  <div
    class="screenshot"
    *ngIf="
      (steps$ | async)[index]?.screenshot || screenshots?.current;
      else hyphen
    ">
    <i
      class="screen-image"
      *ngIf="status == 'running' || status == 'waiting'; else showBefore"
      [ngClass]="status"></i>
    <ng-template #showBefore>
      <i
        class="screen-preview"
        matTooltip="View screenshot"
        matTooltipPosition="above"
        (click)="openScreenshot('current')"
        [style.backgroundImage]="getScreenshot('current')"></i>
    </ng-template>
  </div>
  <div class="screenshot" *ngIf="(steps$ | async)[index]?.compare; else hyphen">
    <i
      class="screen-image"
      *ngIf="status != 'success'; else showBefore"
      [ngClass]="status"></i>
    <ng-template #showBefore>
      <i
        class="screen-preview"
        matTooltip="View screenshot"
        matTooltipPosition="above"
        (click)="openScreenshot('template')"
        [style.backgroundImage]="getScreenshot('template')"></i>
    </ng-template>
  </div>
  <div class="screenshot" *ngIf="(steps$ | async)[index]?.compare; else hyphen">
    <i
      class="screen-image"
      *ngIf="status != 'success'; else showBefore"
      [ngClass]="status"></i>
    <ng-template #showBefore>
      <i
        class="screen-preview"
        matTooltip="View screenshot"
        matTooltipPosition="above"
        (click)="openScreenshot('difference')"
        [style.backgroundImage]="getScreenshot('difference')"></i>
    </ng-template>
  </div>
  <div
    class="screenshot"
    *ngIf="this.rest_api || this.vulnerable_headers_count || (healingData$ | async); else hyphen">
    <i
      class="api_call"
      *ngIf="this.rest_api"
      matTooltip="View HTTP Request"
      matTooltipPosition="above"
      (click)="openRequest()">
      <mat-icon>http</mat-icon>
    </i>
    <i
      class="api_call"
      *ngIf="this.vulnerable_headers_count"
      matTooltip="Security Vulnerability | {{
        this.vulnerable_headers_count
      }} Requests response has vulnerable headers values, refer to execution reports for details"
      matTooltipPosition="above">
      <mat-icon [ngStyle]="{ color: 'red' }">report_problem</mat-icon>
    </i>
    <i
      class="api_call healing-badge"
      *ngIf="healingData$ | async as healingData"
      [matTooltip]="getHealingTooltip(healingData)"
      matTooltipPosition="above">
      <mat-icon [ngStyle]="{ color: 'orange' }">healing</mat-icon>
    </i>
  </div>
  <ng-template #hyphen>
    <div class="screenshot">-</div>
  </ng-template>
</div>
<div class="error-row" *ngIf="error$ | async as error">
  <div class="error-header">
    <span>Error Details:</span>
    <div class="loop-error-context" *ngIf="failedLoopInfo?.wasInLoop && !isInsideLoop && !isLoopStep">
      <mat-icon class="loop-error-icon">repeat</mat-icon>
      <span class="loop-error-text">{{ getFailedIterationsText() }}</span>
    </div>
  </div>
  <div class="error-message">{{ error }}</div>
</div>
<!-- Browser-Use AI Agent Logs for this step -->
<div class="browser-use-logs-row" *ngIf="isAIAgentStep() && (aiLogs$ | async) as logs" [hidden]="!logs || logs.length === 0">
  <div class="logs-header" (click)="toggleAILogs()">
    <mat-icon class="expand-icon" [class.expanded]="showAILogs">expand_more</mat-icon>
    <mat-icon class="ai-icon">smart_toy</mat-icon>
    <span class="logs-title">AI Agent Logs</span>
  </div>
  <div class="logs-container" *ngIf="showAILogs">
    <div
      class="log-entry"
      [ngClass]="'log-' + log.level"
      [attr.data-is-step-indicator]="log.message.includes('ðŸ“ Step') ? 'true' : null"
      *ngFor="let log of logs"
    >
      <span class="log-timestamp">{{ log.timestamp | date:'HH:mm:ss' }}</span>
      <span class="log-message" [innerHTML]="formatBrowserUseLog(log.message)"></span>
    </div>
  </div>
</div>
