<draggable-window></draggable-window>
<ng-container *ngIf="feature$ | async as feature; else loader">
  <h2 mat-dialog-title>Live Steps Viewer: {{ feature.feature_name }}</h2>
  <mat-dialog-content>
    <ng-container
      *ngIf="
        (status$ | async) != 'queued' && results$ | async as results;
        else loader
      ">
      <mat-tab-group *ngIf="lastFeatureRunID | storeSelector | async as run_id">
        <ng-container *ngLet="results.results[run_id] | keyvalue as browsers">
          <ng-container
            *ngIf="
              browsers?.length > 0;
              then browserTabs;
              else loader
            "></ng-container>
          <!-- show browsers -->
          <ng-template #browserTabs>
            <mat-tab *ngFor="let browser of browsers; trackBy: trackBrowserFn">
              <ng-template
                mat-tab-label
                *ngLet="browser.value.feature_result_id as feature_result_id">
                <div class="browser-tab">
                  <i
                  class="browser-icon"
                  [style.backgroundImage]="
                    browser.value.browser_info | browserIcon
                  "></i>
                   {{ browser.value.browser_info | browserComboText }}
                  <mat-icon

                  class="browser-icon live_preview"
                  matTooltipPosition="below"
                  matTooltip="View your browser execution, GO live!"
                  *ngIf="showLiveIcon(browser)"
                  (click)="live(feature_result_id)"
                  >live_tv</mat-icon>
                </div>
                <!-- contains mobiles -->
                <div class="father-mobile-container">
                  <ng-container>
                    <span class="separator-text"></span>
                    <!-- single and multiple mobiles -->
                    <div class="mobile-selection-container">
                      <div 
                        *ngIf="mobiles[feature_result_id]?.length >= 1"
                        class="multiple-mobiles-container">
                        <div 
                          *ngFor="let mobile of mobiles[feature_result_id]; trackBy: trackMobileFn"
                          class="mobile-row"
                          [class.selected]="selectedMobile?.id === mobile.id"
                          [matTooltip]="'Click to connect to this mobile device'">
                          <div (click)="noVNCMobile(mobile.hostname)" class="mobile-option">
                            <mat-icon class="mobile-icon">smartphone</mat-icon>
                            <span class="mobile-name">{{ mobile.name || mobile.hostname }}</span>
                            <span class="mobile-status" *ngIf="mobile.status">
                              <mat-icon [class]="mobile.status.toLowerCase()">fiber_manual_record</mat-icon>
                              {{ mobile.status }}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="mobile-info" *ngIf="selectedMobile">
                        <span class="info-item">
                          <mat-icon>info</mat-icon>
                          {{ selectedMobile.name || selectedMobile.hostname }}
                        </span>
                        <span class="info-item" *ngIf="selectedMobile.status">
                          <mat-icon>fiber_manual_record</mat-icon>
                          {{ selectedMobile.status }}
                        </span>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </ng-template>

              <ng-container *ngIf="browser.value?.error; else browserContent">
                <div>
                  <div class="live-status">
                    <div class="status-icon timeout"></div>
                    {{ browser.value.error }}
                  </div>
                </div>
              </ng-container>
              <ng-template #browserContent>
                <!-- Live Status for every browser result tab -->
                <ng-container
                  *ngLet="
                    feature_id
                      | browserResultStatus: run_id : browser.value.browser_info
                      | storeSelector
                      | async as browserStatus
                  ">
                  <div [ngSwitch]="browserStatus">
                    <!-- Status: Initializing -->
                    <ng-container *ngSwitchCase="'Initializing'">
                      <div class="live-status">
                        <mat-spinner
                          color="primary"
                          diameter="20"></mat-spinner>
                        <ng-container
                          *ngTemplateOutlet="resultStatusText"></ng-container>
                        <ng-container
                          *ngTemplateOutlet="counter"></ng-container>
                      </div>
                    </ng-container>
                    <!-- Status: Timeout -->
                    <ng-container *ngSwitchCase="'Timeout'">
                      <div class="live-status">
                        <div class="status-icon timeout"></div>
                        <ng-container
                          *ngTemplateOutlet="resultStatusText"></ng-container>
                        <ng-container
                          *ngTemplateOutlet="counter"></ng-container>
                      </div>
                    </ng-container>
                    <!-- Status: Completed -->
                    <ng-container *ngSwitchCase="'Completed'">
                      <div class="live-status">
                        <div class="status-icon checked"></div>
                        <ng-container
                          *ngTemplateOutlet="resultStatusText"></ng-container>
                        <ng-container
                          *ngTemplateOutlet="counter"></ng-container>
                      </div>
                    </ng-container>
                    <!-- Status: Any other (steps) -->
                    <ng-container *ngSwitchDefault>
                      <div class="live-status">
                        <mat-spinner
                          color="primary"
                          diameter="20"></mat-spinner>
                        <div class="status-text">
                          {{ browser.value.status }}
                        </div>
                        <ng-container
                          *ngTemplateOutlet="counter"></ng-container>
                      </div>
                    </ng-container>
                  </div>
                  <!-- Template for Live Counter -->
                  <ng-template #counter>
                    <div class="counter">
                      {{
                        browser.value.start_at
                          | amParse
                          | testDuration: browser.value.end_at
                          | async
                      }}
                    </div>
                  </ng-template>
                  <!-- Template for Feature Result Status -->
                  <ng-template #resultStatusText>
                    <div class="status-text">
                      {{ 'websockets.' + browser.value.status | translate }}
                    </div>
                  </ng-template>
                  <!-- Template for Feature Result running steps -->
                  <ng-container
                    *ngIf="
                      browserStatus !== 'Initializing' &&
                      browserStatus !== 'Timeout' &&
                      browserStatus !== 'Queued'
                    ">
                    <div class="headers">
                      <div class="index">#</div>
                      <div class="text">Step definition</div>
                      <div class="screenshot">Screenshot</div>
                      <div class="screenshot">Compare</div>
                      <div class="screenshot">Difference</div>
                      <div class="screenshot">Others</div>
                    </div>
                    <div class="steps-container" [attr.browser]="browser.key">
                      <cometa-live-step
                        *ngFor="
                          let step of steps$ | async;
                          trackBy: trackStepFn;
                          let i = index
                        "
                        [featureRunID]="run_id"
                        [browser]="browser.value.browser_info"
                        [step]="step"
                        [feature_id]="feature_id"
                        [steps$]="steps$"
                        [index]="i"
                        [feature_result_id]="browser.value.feature_result_id"
                        (updateMobiles)="updateMobile($event)"
                        ></cometa-live-step>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-template>
            </mat-tab>
          </ng-template>

        </ng-container>
        <!-- Healing Summary Tab (only shown when healing data exists) -->
        <mat-tab *ngIf="getHealingSummary(run_id)">
          <ng-template mat-tab-label>
            <mat-icon class="healing-tab-icon">healing</mat-icon>
            Healing Summary
          </ng-template>
            <div class="healing-summary-container">
              <ng-container *ngIf="getHealingSummary(run_id) as summary">
                <div class="healing-summary-header">
                  <h3>Self-Healing Statistics</h3>
                  <div class="healing-stats">
                    <div class="stat-item">
                      <mat-icon>check_circle</mat-icon>
                      <span class="stat-label">Total Healed Steps:</span>
                      <span class="stat-value">{{ summary.totalHealed }}</span>
                    </div>
                    <div class="stat-item">
                      <mat-icon>trending_up</mat-icon>
                      <span class="stat-label">Average Confidence:</span>
                      <span class="stat-value">{{ summary.averageConfidence }}%</span>
                    </div>
                    <div class="stat-item">
                      <mat-icon>timer</mat-icon>
                      <span class="stat-label">Total Healing Time:</span>
                      <span class="stat-value">{{ summary.totalHealingTime }}ms</span>
                    </div>
                  </div>
                </div>
                <div class="healing-summary-list">
                  <h4>Healed Elements</h4>
                  <div class="healed-step" *ngFor="let healedStep of summary.healedSteps">
                    <div class="healed-step-header">
                      <span class="step-index">Step {{ healedStep.stepIndex + 1 }}:</span>
                      <span class="step-name">{{ healedStep.stepName }}</span>
                      <span class="browser-info">
                        <i
                          class="browser-icon-small"
                          [style.backgroundImage]="healedStep.browser | browserIcon"
                        ></i>
                        {{ healedStep.browser | browserComboText }}
                      </span>
                    </div>
                    <div class="healed-step-details">
                      <div class="selector-change">
                        <mat-icon class="change-icon">arrow_forward</mat-icon>
                        <code class="old-selector">{{ healedStep.originalSelector }}</code>
                        <mat-icon class="arrow-icon">arrow_right_alt</mat-icon>
                        <code class="new-selector">{{ healedStep.healedSelector }}</code>
                      </div>
                      <div class="healing-metadata">
                        <span class="metadata-item">
                          <mat-icon>speed</mat-icon>
                          Confidence: {{ healedStep.confidence }}%
                        </span>
                        <span class="metadata-item">
                          <mat-icon>timer</mat-icon>
                          Time: {{ healedStep.healingTime }}ms
                        </span>
                        <span class="metadata-item">
                          <mat-icon>build</mat-icon>
                          Method: {{ healedStep.method }}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="no-healing" *ngIf="summary.healedSteps.length === 0">
                    <mat-icon>info</mat-icon>
                    <p>No elements required healing during this test run.</p>
                  </div>
                </div>
              </ng-container>
            </div>
          </mat-tab>
      </mat-tab-group>
    </ng-container>
  </mat-dialog-content>
  <mat-checkbox
    color="primary"
    [checked]="autoScroll"
    (change)="handleScrollChange($event)"
    >Scroll automatically</mat-checkbox
  >
  <mat-dialog-actions>
    <button
      mat-stroked-button
      (click)="stopTest()"
      matTooltipPosition="after"
      [matTooltip]="!canStop ? ('live_steps.button_when_starting' | translate) : ('live_steps.button_stop' | translate)"
      color="warn"
      [disabled]="isLoading || !canStop"
      class="stop-button">
      <div class="button-content">
        <ng-container *ngIf="!isLoading">
          STOP EXECUTION
        </ng-container>
        <mat-spinner *ngIf="isLoading" diameter="20" class="inline-spinner" color="warn"></mat-spinner>
      </div>
    </button>
    <button mat-stroked-button color="primary" mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-container>
<ng-template #loader>
  <mat-spinner color="primary" diameter="20"></mat-spinner>
</ng-template>
