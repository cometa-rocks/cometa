<h2 mat-dialog-title>Export Features</h2>
<div mat-dialog-content class="content" *ngIf="!loading && !error; else stateBlock">
  <div class="summary">
    <div class="title">Select which folders and features to include in the export.</div>
    <div class="counts">{{ selectedCount }} of {{ totalCount }} feature{{ totalCount === 1 ? '' : 's' }} selected</div>
  </div>

  <ng-container *ngIf="rootNode as root">
    <div class="tree">
      <ng-container *ngTemplateOutlet="folderNode; context: { $implicit: root }"></ng-container>
    </div>
  </ng-container>
</div>

<ng-template #stateBlock>
  <div class="state" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading export dataâ€¦</span>
  </div>
  <div class="state error" *ngIf="!loading && error">
    <mat-icon>error_outline</mat-icon>
    <span>{{ error }}</span>
  </div>
</ng-template>

<ng-template #folderNode let-folder>
  <div class="node folder" [style.padding-left.px]="folder.depth === 0 ? 0 : folder.depth * 24">
    <button
      type="button"
      class="collapse-indicator mat-icon-button"
      *ngIf="folder.features.length || folder.folders.length"
      mat-icon-button
      (click)="toggleCollapse(folder, $event)"
    >
      <mat-icon>{{ folder.collapsed ? 'chevron_right' : 'expand_more' }}</mat-icon>
    </button>
    <span class="collapse-placeholder" *ngIf="!(folder.features.length || folder.folders.length)"></span>
    <mat-checkbox
      color="primary"
      [checked]="folder.checked"
      [indeterminate]="folder.indeterminate"
      (change)="toggleFolder(folder, $event.checked)"
    >
      <span class="label">
        <mat-icon class="icon">{{ folder.depth === 0 ? 'domain' : 'folder' }}</mat-icon>
        <span class="name">{{ folder.name }}</span>
      </span>
    </mat-checkbox>
  </div>
  <div class="children" *ngIf="!folder.collapsed">
    <div
      class="node feature"
      *ngFor="let feature of folder.features"
      [style.padding-left.px]="(folder.depth + 1) * 24"
    >
      <span class="collapse-placeholder"></span>
      <mat-checkbox
        color="primary"
        [checked]="feature.checked"
        (change)="toggleFeature(feature, $event.checked)"
      >
        <span class="label">
          <span class="name">{{ feature.name }}</span>
          <span class="feature-id" *ngIf="feature.featureId">#{{ feature.featureId }}</span>
        </span>
      </mat-checkbox>
    </div>
    <ng-container *ngFor="let child of folder.folders">
      <ng-container *ngTemplateOutlet="folderNode; context: { $implicit: child }"></ng-container>
    </ng-container>
  </div>
</ng-template>

<div mat-dialog-actions>
  <button mat-stroked-button color="warn" (click)="close()">Cancel</button>
  <button mat-flat-button color="primary" [disabled]="loading || !!error || selectedCount === 0" (click)="exportSelection()">
    Export
  </button>
</div>
